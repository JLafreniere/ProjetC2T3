
<head>
    <title>Stage en programmation - C2T3</title>
    <title>STAGE C2T3</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="icon2.png">
    <link href="~/Content/Site.css" rel="stylesheet" type="text/css" media="screen" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    
    <style>
          /* Always set the map height explicitly to define the size of the div
        * element that contains the map. */
          #map {
              height: 600px;
              width: 100%;
              margin: 0 auto;
          }
          /* Optional: Makes the sample page fill the window. */
          html, body {
              height: 100%;
              margin: 0;
              padding: 0;
          }
    </style>
</head>
<body>
    

    <script>
        var infoWindow;
        var TrackPosition = false;
    </script>

 


    <!-- PAGE BODY -->
    <div class="container">
        <div class="row">
            <div class="col-xs-12" style="background-color:transparent ;  width:100%">
                <h1 style="text-align: center">
                    Stage en programmation<br>
                    <small>Démo des fonctionnalités recherchées</small>
                </h1>
            </div>
        </div>
        <div class="row spacer" style="background-color:white">
        </div>
        <!-- /.row -->
        <div class="container-fluid">
            <div class="row" style="text-align: center">

                        <!-- Form Name -->
                        <h2 style="text-align: center; width:100%">Localisation</h2><hr />
                @if (ViewBag.positionEnregistree != null)
                {
                    <div style="width:300px;
height:70px;

background-color: lightgreen;

display: inline-block;
vertical-align: text-top">
                        <h3 style="text-align: center; margin-left: 5%; margin-top: 10px"><span> POSITION ENREGISTRÉE </span></h3>
                    </div>
                }


                        <div class="row">
                            <div class="col-xs-12 col-md-6 col-xl-6" align="center" id="bouton"><input  type="button"  class="btn btn-info" value="Obtenir ma position " onclick="initMap();"></div>
                            
     
                                <!-- form here -->
                            @using (Html.BeginForm("CreerEntreeGPS", "Home", null, FormMethod.Post, new { @id = "gps", @name = "myForm" })) {
                                <div class="col-xs-12 col-md-6 col-xl-6" align="center">
                                    <input type="button" class="btn btn-info" value="Enregistrer en BD" onclick="enregistrerPosition()">
                                </div>
                                <br>
                                <div id="champsGPS">
                                    <label class="mg-right" for="txtLat">Latitude</label><input type="text" name="lat" id="txtLat" v><br><br>
                                    <label class="mg-right">Longitude</label><input type="text" name="long" id="txtLong"><br><br>
                                    <label class="mg-right" for="id_appareil">Appareil</label><input type="text" name="id_appareil" id="id_appareil" value="Appareil 1"><br><br>

                                </div>
                                <script>$("#champsGPS").css("margin-left", "10%");
                                    $("#champsGPS").css("margin-right", "10%");

                                    function enregistrerPosition() {


                                        $.ajax({

                                            method: "POST",
                                            url: "/Home/CreerEntreeGPS",
                                            data: {
                                                lat : $("#txtLat").val(),
                                                long: $("#txtLong").val(),
                                                id_appareil: $("#id_appareil").val()
                                            }

                                        })
                         .success(function (result) {

                         })
                         .error(function (xhr, status) {
                             alert(status);
                         })

                                    }
                            </script>
                            }
                            <div id="tableauEntrees">
                                <h3 style="text-align:center"> Entrées existantes</h3>
                                @{
                                    List<WEB_APP_C2T3.Models.EntreeGPS> a = ViewBag.gps;
                                    <div style="text-align: center">
                                        <table style="width: 90%" align="center" cellspacing="10" cellpadding="8">
                                            <tr><th>Appareil</th><th>Latitude</th><th>Longitude</th><th id="Afficher"></th><th id="supprimer"></th></tr>
                                            @for (int i = 0; i < a.Count; i++)
                                            {
                                                <tr style="text-align: center" id=@{ Write("\""); Write(a[i].Id); Write("\"");}>


                                                    <td>@{Write(a[i].appareil);} </td>
                                                    <td> @{Write(a[i].latitude);} </td>
                                                    <td>@{Write(a[i].longitude); } </td>
                                                    <td>
                                                        <button class="btn btn-info marker" value="Afficher sur la carte" onclick="var pos = {lat: @a[i].latitude , lng:  @a[i].longitude}; map.setCenter(pos);         var marker = new google.maps.Marker({
                                                         position: pos,
                                                                  map: map,
                                                       title: '@a[i].appareil',
                                                     label:  '@a[i].appareil'

                                                                  }); infoWindow.close();">
                                                            <span class="glyphicon glyphicon-map-marker"></span>
                                                        </button>
                                                    </td>

                                                    <td> <a><span class="glyphicon glyphicon-remove" onclick="supprimerRangee(@{Write(a[i].Id);})"></span> </a></td>
                                                </tr>
    }

                                        </table>
                                        <script>
                                            $("th").css("text-align", "center");
                                            $("tr:odd").css("background-color", "#F3F3F3");
                                            $("tr:even").css("background-color", "#E0E0E0");
                                            $("th").css("background-color", "#C0C0C0");
                                            console.log("test");
                                        </script>
                                    </div>
                                }
                            </div>

                            

                            <div class="col-xs-12">
                                <div id="map"></div>
                                <script>

                                    function initMap() {
                                        map = new google.maps.Map(document.getElementById('map'), {
                                            center: {
                                                lat: -34.397,
                                                lng: 150.644
                                            },
                                            zoom: 10
                                        });
                                            infoWindow = new google.maps.InfoWindow({
                                            map: map
                                        });

                                        // Try HTML5 geolocation.
                                        if (navigator.geolocation) {
                                            navigator.geolocation.getCurrentPosition(function (position) {
                                                var pos = {
                                                    lat: position.coords.latitude,
                                                    lng: position.coords.longitude

                                                };
                                                latitude = position.coords.latitude;
                                                longitude = position.coords.longitude;

                                                infoWindow.setPosition(pos);
                                                infoWindow.setContent('Position trouvée! Lat: ' + latitude + "   Lon: " + longitude);
                                                map.setCenter(pos);

                                                document.getElementById("txtLat").value = latitude;
                                                document.getElementById("txtLong").value = longitude;

                                            }, function () {
                                                handleLocationError(true, infoWindow, map.getCenter());
                                            });
                                        } else {
                                            // Browser doesn't support Geolocation
                                            handleLocationError(false, infoWindow, map.getCenter());
                                        }
                                    }

                                    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                                        infoWindow.setPosition(pos);
                                        infoWindow.setContent(browserHasGeolocation ?
                                            'Error: The Geolocation service failed.' :
                                            'Error: Your browser doesn\'t support geolocation.');
                                    }


                            </script>
                            </div>
                            <div style="text-align: center">
                                <br />
                                <button onclick="initMap()" class="btn btn-info">Effacer les marqueurs</button>
                            </div>
                        </div>
                        <!-- Text input-->

                <br><br>
                <button id="btnStartStopTracking" class="btn btn-default" style="color:white">Démarrer le Tracking</button><br />
                <span id="last_update"></span>
                <br /><br />
                <script>
                    $("#btnStartStopTracking").css("background-color", "red");
                    

                    $('#btnStartStopTracking').click(function () {
                        
                        TrackPosition = !TrackPosition;
                        


                        
                        
                        if (TrackPosition) {
                            var idInterval = setInterval(function () {

                                $.ajax({

                                    method: "POST",
                                    url: "/Home/EnregistrerPosition",
                                    data: { lat: $("#txtLat").val(), long: $("#txtLong").val(), id_appareil: $("#id_appareil").val() }

                                })
                                        .success(function (result) {

                                        })
                                        .error(function (xhr, status) {
                                            alert(status);
                                        })

                                $("#last_update").html("<br>Dernière mise à jour: " + new Date().toLocaleString());

                            }, 5000);
                            
                            $("#btnStartStopTracking").css("background-color", "green");
                            $("#btnStartStopTracking").html("Arrêter le Tracking")
                        } else {
                            clearInterval(idInterval);
                            $("#btnStartStopTracking").css("background-color", "red");
                            $("#btnStartStopTracking").html("Démarrer le Tracking")
                        }

                    });

                </script>



                <form class="form-horizontal">
                    <fieldset>
                        <!-- Form Name -->
                        <legend style="text-align: center">Envoi et réception d'alertes au serveur</legend>
                        <div class="row">
                            <div class="col-xs-6" style="text-align: center">
                                <div class="row">
                                        <span id="rectangle" align="center">État du serveur</span>
                                        @{


                                            if (ViewBag.nbAlertes > 0)
                                            {
                                                <script>document.getElementById("rectangle").style.backgroundColor = "red";</script>
                                            }
                                        }
                                </div>

                            </div>

                            <div class="col-xs-6"><input type="button" name="Envoyer une alerte" value="Envoyer une alerte" align="center" style="margin-top: 32px;"onclick="envoyerAlerte()"></div>
                            <script>

                                    function envoyerAlerte() {
                                                    $.ajax({

                method: "POST",
                url: "/Home/EnvoyerAlerte/7",
                

            })
                                     .success(function (result) {

                                     })
                                     .error(function (xhr, status) {
                                         alert(status);
                                     })
                                    }</script>
                        </div>
                        <div class="row">

                            <div class="col-xs-12" style="text-align: center">
                                <!--<input type="button" value="Effacer les alertes" onclick="location.href='-->
                                <button type="button" onclick="resetAlertes();">Effacer les alertes</button>
                                <script>
                                    function resetAlertes() {
                                                   $.ajax({

                method: "POST",
                url: "/Home/EffacerAlertes",
                

            })
                                     .success(function (result) {

                                     })
                                     .error(function (xhr, status) {
                                         alert(status);
                                     })
                                    }</script>
                            </div>

                        </div>
                        <!-- Text input-->
                    </fieldset>
                </form>
                <br><br>
                <form class="form-horizontal">
                    <fieldset>
                        <!-- Form Name -->
                        <legend style="text-align: center">Envoi de SMS</legend>
                        <div class="row">
                            <div class="col-xs-12 col-md-6" style="text-align: center">
                                <div>
                                    <div class="col-md-6"><label for="txtNoTel">No. Tel:</label></div>
                                    <div class="col-md-6"><input type="text" style="width: 100%" align="center"></div>
                                </div>
                            </div>
                            <div class="col-xs-12 col-md-6" style="text-align: center">
                                <div>
                                    <div class="col-md-6"><label for="txtMessage">Message</label></div>
                                    <div class="col-md-6"><input type="text" style="width: 100%"></div>
                                </div>
                            </div>
                            <div class="col-xs-12"><input type="submit" value="Envoyer"></div>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>
    <script>


        function supprimerRangee(id) {
            console.log(id + " suppression");
            $.ajax({

                method: "POST",
                url: "/Home/SupprimerEntreeGPS",
                data: { id_entree: id }

            })
                                     .success(function (result) {

                                     })
                                     .error(function (xhr, status) {
                                         alert(status);
                                     })

        }


    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxF-Wa_6YWDRLneBhqqIqkkNXlwMaKN1I&callback=initMap" async defer></script>
</body>